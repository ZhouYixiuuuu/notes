# Cassandra

## 分区

![image-20241108145405982](https://raw.githubusercontent.com/ZhouYixiuuuu/picture/master/imgs/202411081454614.png)

- 在 Cassandra 中，分区键（Partition Key）是决定数据如何在集群节点间分布的关键因素。它是用于确定数据存储位置的一个或一组列。当向 Cassandra 表中插入数据时，首先**根据分区键的值来确定数据应该存储在哪个节点以及该节点上的哪个分区（Partition）**。
- Cassandra 使用分区键来对数据进行哈希运算。哈希函数会根据分区键的值计算出一个哈希码，这个哈希码用于确定数据存储在集群中的哪个节点上。

```CQL
CREATE TABLE user_data (
    user_id text,
    user_name text,
    user_email text,
    PRIMARY KEY ((user_id))
);
```

通过分区键可以**快速定位**到数据存储的位置。

## 聚类键

聚类键（Clustering Key）是主键（Primary Key）的一部分，它用于**在分区（由分区键确定）内部对数据进行排序**。当数据按照分区键被划分到不同分区后，聚类键决定了这些数据在分区内部的存储顺序。

```
CREATE TABLE user_orders (
    user_id text,
    order_date timestamp,
    order_amount decimal,
    PRIMARY KEY ((user_id), order_date)
);
```

在这个表中，`user_id`是分区键，`order_date`是聚类键。首先，数据会根据`user_id`的值进行哈希运算，将属于同一个`user_id`的数据存储到同一个分区中。然后，在每个分区内部，数据会按照`order_date`的顺序进行存储。

聚类键的顺序决定了数据在分区内的排序顺序。

## 查询注意事项

1. 在查询时，如果没有包含分区键作为筛选条件（特别是在没有使用索引的情况下），Cassandra 会扫描所有分区来查找符合条件的数据，这将导致非常高的性能开销。
2. 在使用`ALLOW FILTERING`时要格外谨慎。虽然它允许在查询中使用没有基于索引或分区键的筛选条件，但会导致全表扫描，对于大规模数据会消耗大量的系统资源并显著降低查询速度。只有在数据量较小且确定性能影响可接受的情况下，才考虑使用`ALLOW FILTERING`。
3. 当使用`ORDER BY`进行排序时，只能对聚类键（Clustering Key）进行排序。如果试图对非聚类键进行排序，会导致错误。
4. 如果按照**聚类键的存储顺序**来书写 WHERE 语句中的条件，Cassandra 可以更高效地利用数据在分区内的存储结构来定位和筛选数据。

## 哈希环

 一个新节点加入哈希环的过程：

1. 准备
   * 节点配置信息确认
   * 使用哈希函数（如 MD5、SHA - 1 等，Cassandra 内部有自己的哈希算法）对节点的标识信息进行哈希计算，得到一个唯一的哈希值。这个哈希值将对应哈希环上的一个点，用于表示该节点在哈希环上的位置。
2. **通知集群现有节点**：新节点会向集群中的现有节点发送加入请求。这个请求通常通过 Gossip 协议（Cassandra 用于节点间通信的协议）来发送。Gossip 协议使得新节点能够将自己的存在和相关信息（如哈希值、存储容量等）传播给其他节点。
3. **数据迁移和重新分配的协商**：当现有节点收到新节点的加入请求后，集群会根据新节点的哈希值以及当前的数据分布情况，确定哪些数据需要从现有节点迁移到新节点。这个过程涉及到对数据分区（Partition）的重新计算。
4. **更新元数据和路由信息**：在数据迁移的同时，集群中的所有节点（包括新节点）会更新自己的元数据和路由信息。元数据记录了每个节点在哈希环上的位置、负责存储的分区范围等信息。路由信息则用于在查询数据时，快速确定数据存储在哪一个节点上。通过更新这些信息，集群能够确保后续的数据操作（如写入、读取）能够正确地定位到相应的节点。
5. **数据迁移操作执行**：根据协商好的分区迁移计划，现有节点会将相应的数据分区复制到新节点。这个过程可能会涉及到大量的数据传输，并且需要确保数据的完整性和一致性。在数据迁移完成后，新节点就正式成为哈希环的一员，开始参与数据的存储和处理任务。

在整个过程中，是**完全没有宕机时间**的：

1. 在新节点加入的过程中，其他节点依然可以正常地处理读写请求，因为 Gossip 协议在后台默默地进行信息更新，不会对正在进行的操作造成干扰。
2. **数据渐进式迁移**：数据从现有节点迁移到新节点是一个渐进的过程。在新节点加入后，集群会确定需要迁移的数据范围，然后逐步地将这些数据复制到新节点。这个过程不是一次性完成的，而是在不影响正常服务的情况下，利用**系统的空闲资源**进行数据迁移。
3. Cassandra 是一种无主（Peer - to - Peer）架构的数据库。这意味着没有一个中央控制节点来协调所有的操作。这种分布式的协调方式使得系统能够更加灵活地应对新节点的加入，而不会因为单点故障（如主节点故障）导致宕机。

## 负载均衡策略

**什么是token？**

假设哈希环的范围是 0 - 100，有 3 个节点 A、B、C，它们的令牌值分别是 20、40、70。当有一个数据分区的分区键哈希后对应的令牌值是 30 时，根据规则，这个数据分区会存储在节点 B 上，因为 30 介于节点 A 的 20 和节点 B 的 40 之间，且按顺时针方向下一个节点是 B。

在 Cassandra 中，令牌（Token）是一种用于确定数据在集群节点间分布的标识符。

### TokenAwarePolicy

driver chooses node which contains the data

客户端知道集群状态。客户端已经知道数据存储的节点（例如通过之前的操作缓存了信息），就直接将请求发送到该节点。

### RoundRobinPolicy

driver round robins the ring

假设集群中有节点 A、B、C，第一个请求分配给 A，第二个给 B，第三个给 C，然后第四个又回到 A，如此循环。

当请求被发送到节点 A 时：

* 读请求：
  * 若数据在节点 A 存储，它会从本地存储介质（如磁盘上的 SSTables）中检索数据。
  * 若数据不在节点 A 存储，节点 A 会根据集群的路由信息，将请求转发给真正存储数据的节点，或者向客户端返回一个提示，告知数据不在本节点。
* 写请求：
  * 对于写请求，节点 A 同样要先确定数据所属的分区，判断自己是否是该数据分区的存储节点之一（在某些**复制**策略下，数据可能会存储在多个节点）。
  * 如果是，节点 A 会将数据写入本地的提交日志（Commit Log）以保证数据的持久性，然后将数据写入对应的内存结构（如 Mem - Table）。当内存中的数据达到一定阈值时，会将其刷新为磁盘上的 SSTables。在这个过程中，还会涉及到与其他副本节点（如果有）的协调，以确保数据的一致性。例如，使用 Quorum 等一致性级别来保证在多个副本节点中写入成功的数量达到要求。

### DCAwareRoundRobinPolicy

driver round robins the target data center

主要用于多数据中心的 Cassandra 集群。例如，在包含数据中心 DC1 和 DC2 的集群中，若请求来自 DC1 中的客户端，会优先分配给 DC1 中的节点，只有 DC1 节点无法满足请求时，才会考虑 DC2 中的节点。（在DC1中使用轮询的方式）

## P2P

- **写请求**：客户端可将请求发送到**任意节点（协调节点）**，协调节点确定存储节点后发送请求。存储节点先写提交日志，再写内存数据结构，最后刷新到磁盘。协调节点根据**一致性级别**判断写操作是否成功。
- **读请求**：读请求也可发送到任意节点，该节点确定存储节点后获取数据，会按策略返回数据，过程可能涉及合并和过滤。

## 虚拟节点

虚拟节点是**将一个物理节点在逻辑上划分为多个更小的单元**，每个单元就像一个虚拟的节点，它们也有自己对应的令牌范围来存储数据。

* 例如，一个存储容量大的节点和一个存储容量小的节点被分配了相同数量的令牌范围，那么小容量节点可能会很快被数据填满，而大容量节点还有很多剩余空间。有了虚拟节点后，数据可以更精细地分布。每个虚拟节点都参与数据分区的分配，使得数据能够根据物理节点的实际资源情况（如磁盘空间）更合理地分布在集群中。

* 在节点加入和删除时更加灵活，避免大量的数据迁移。

  在没有虚拟节点的传统 Cassandra 数据分布模式中：数据迁移量大

  | 节点 | 前范围  | 后范围  |
  | ---- | ------- | ------- |
  | A    | 0~1/3   | 0~1/4   |
  | B    | 1/3~2/3 | 1/4~2/4 |
  | C    | 2/3~1   | 2/4~3/4 |
  | D    |         | 3/4~1   |

  使用虚拟节点，只有与该物理节点**相关的虚拟节点**的令牌范围需要调整，而不是像传统模式那样大规模地重新分配所有数据分区。这样可以减少数据迁移量。

## Gossip协议

Gossip 协议是 Cassandra 用于节点间通信的一种机制，它是一种去中心化的、基于消息传递的协议。通过这个协议，节点之间能够交换信息，从而让每个节点都能了解集群的整体状态。

交换的内容：

* **节点状态信息**：包括节点是否正常运行、是否正在进行数据迁移、是否处于维护模式等状态。
* **集群拓扑结构信息**：节点会交换关于数据中心和机架的信息，以及每个节点在集群中的位置。这有助于节点了解集群的物理布局，例如哪些节点在同一数据中心、哪些在同一机架，方便进行数据存储和读取的优化。
* **数据分布情况**：交换每个节点负责的数据分区范围（通过分区键的哈希范围来表示）以及数据的副本位置等信息。

## Snitch

什么是机架（Rack）？

在实际的数据中心环境中，机架是一种用于放置服务器设备的物理架子。多个服务器可以安装在一个机架上，通常这些服务器通过网络连接在一起组成一个集群。Cassandra 利用机架信息来**确保数据的副本不会都存储在同一个机架上**，这样可以提高系统的容错性。为了使读取操作高效，**Cassandra 使用来自 snitch 的信息来识别将最快返回副本的节点。**

**常见的机架感知 snitch 类型**

- **SimpleSnitch**：这是一种简单的 snitch，适用于单数据中心或没有复杂拓扑结构的环境。它不区分机架信息，只考虑数据中心级别。
- **PropertyFileSnitch**：通过读取配置文件中的属性来确定节点的位置信息。可以手动配置数据中心和机架信息，适用于具有已知固定拓扑结构的集群。
- **GossipingPropertyFileSnitch**：结合了 Gossip 协议和属性文件的特点。节点通过 Gossip 协议交换位置信息，并使用属性文件进行初始配置。这种 snitch 适用于动态变化的环境，可以自动发现节点的位置变化。

## 写入

![image-20241108155021968](https://raw.githubusercontent.com/ZhouYixiuuuu/picture/master/imgs/202411081550467.png)

排序：先按照partition key，再按照Clustering Key

其他的跟LSM-tree一样。